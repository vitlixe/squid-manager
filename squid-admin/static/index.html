<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Squid Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .navbar { margin-bottom: 20px; }
    .card { box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .table th, .table td { vertical-align: middle; }
    .password-field { font-family: monospace; letter-spacing: 2px; }
  </style>
</head>
<body>
<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand mb-0 h1"><i class="bi bi-shield-lock"></i> Squid Manager</span>
  </div>
</nav>

<div class="container">
  <div class="row">
    <div class="col-md-5">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-person-plus"></i> Добавить пользователя
        </div>
        <div class="card-body">
          <div class="mb-3"><input id="last_name" class="form-control" placeholder="Фамилия"></div>
          <div class="mb-3"><input id="first_name" class="form-control" placeholder="Имя"></div>
          <div class="mb-3"><input id="middle_name" class="form-control" placeholder="Отчество"></div>
          <div class="mb-3">
            <select id="status" class="form-select">
              <option value="-" selected>-</option>
              <option value="Студент">Студент</option>
              <option value="Преподаватель">Преподаватель</option>
            </select>
          </div>
          <button class="btn btn-success w-100" onclick="addUser()">
            <i class="bi bi-plus-circle"></i> Добавить
          </button>
        </div>
      </div>
      <button class="btn btn-warning w-100" onclick="reloadSquid()">
        <i class="bi bi-arrow-repeat"></i> Перезагрузить Squid
      </button>
      <div class="card mt-4">
        <div class="card-header">
          <strong>Инструкция:</strong>
        </div>
        <div class="card-body">
          <ul>
            <li><strong>Добавить пользователя:</strong> Заполните форму (Фамилия, Имя, Отчество, Статус) и нажмите <em>Добавить</em>. После создания появятся логин и пароль.</li>
            <li><strong>Поиск:</strong> Используйте поле поиска сверху для фильтрации по ФИО или логину.</li>    
            <li><strong>Показать/скрыть пароль:</strong> Кнопка с <i class="bi bi-eye"></i> переключает отображение пароля.</li>
            <li><strong>Копировать логин и пароль</strong> Кнопка с <i class="bi bi-clipboard"></i> скопирует логин и пароль пользователя в буфер обмена.</li>
            <li><strong>Сброс пароля:</strong> Кнопка <i class="bi bi-key"></i> генерирует новый пароль и показывает его во всплывающем окне.</li>
            <li><strong>Удалить пользователя:</strong> Кнопка <i class="bi bi-trash"></i> удаляет пользователя после подтверждения.</li>
          </ul>
        <div class="alert alert-danger mt-3" role="alert">
          <strong>Важно!</strong> После ВСЕХ изменений на сайте <u>обязательно</u> нажмите кнопку
          <em>«Перезагрузить Squid»</em>, чтобы новые настройки вступили в силу.
        </div>
        </div>
      </div>
    </div>
    <div class="col-md-7">
      <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
          <i class="bi bi-people"></i> Список пользователей
        </div>
        <div class="card-body">
          <div class="mb-3">
            <input id="search" class="form-control" placeholder="Поиск по ФИО или логину" oninput="filterTable()">
          </div>
          <table class="table table-hover" id="usersTable">
            <thead class="table-light">
              <tr>
                <th>ФИО</th>
                <th>Статус</th>
                <th>Логин</th>
                <th>Пароль</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let usersCache = [];

async function loadUsers() {
  let res = await fetch("/api/users");
  usersCache = await res.json();
  renderTable(usersCache);
}

function renderTable(users) {
  let tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML = "";

  users.forEach(u => {
    let fullName = [u.last_name, u.first_name, u.middle_name].filter(Boolean).join(" ");
    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${fullName}</td>
      <td>${u.status || "-"}</td>
      <td><code>${u.login}</code></td>
      <td>
        <span class="password-field" id="pwd-display-${u.login}">${'*'.repeat(u.password.length)}</span>
        <button class="btn btn-sm btn-outline-info ms-1 toggle-btn"
                data-login="${u.login}" data-password="${u.password}" data-state="hidden"
                title="Показать/скрыть пароль"><i class="bi bi-eye"></i></button>
      </td>
      <td>
        <button class="btn btn-sm btn-outline-success me-1"  
                onclick="copyCredentials('${u.login}', '${u.password}', this)" 
                title="Копировать логин и пароль"> 
          <i class="bi bi-clipboard"></i>
        </button>
        <button class="btn btn-sm btn-warning me-1 reset-btn"
                data-login="${u.login}" title="Сбросить пароль">
          <i class="bi bi-key"></i>
        </button>
        <button class="btn btn-sm btn-danger delete-btn"
                data-login="${u.login}" title="Удалить пользователя">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll(".toggle-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      togglePassword(btn.dataset.login, btn.dataset.password, btn);
    });
  });
  tbody.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      deleteUser(btn.dataset.login);
    });
  });
  tbody.querySelectorAll(".reset-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      if (confirm("Сгенерировать новый пароль для " + btn.dataset.login + "?")) {
        let res = await fetch("/api/users/" + encodeURIComponent(btn.dataset.login) + "/password", {
          method: "PUT"
        });
        if (res.ok) {
          let data = await res.json();
          alert(`Новый пароль для ${data.login}: ${data.password}`);
          loadUsers();
        }
      }
    });
  });
}

function filterTable() {
  let query = document.getElementById("search").value.toLowerCase();
  let filtered = usersCache.filter(u => {
    let fullName = [u.last_name, u.first_name, u.middle_name].filter(Boolean).join(" ");
    return (fullName + " " + u.login + " " + (u.status || "-")).toLowerCase().includes(query);
  });
  renderTable(filtered);
}

async function addUser() {
  let user = {
    last_name: document.getElementById("last_name").value.trim(),
    first_name: document.getElementById("first_name").value.trim(),
    middle_name: document.getElementById("middle_name").value.trim(),
    status: document.getElementById("status").value
  };
  let res = await fetch("/api/users", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(user)
  });
  let newUser = await res.json();
  alert(`Пользователь добавлен в таблицу:\nЛогин: ${newUser.login}\nПароль: ${newUser.password}\nСтатус: ${newUser.status}`);

  document.getElementById("last_name").value = "";
  document.getElementById("first_name").value = "";
  document.getElementById("middle_name").value = "";
  document.getElementById("status").value = "-";

  loadUsers();
}

async function deleteUser(login) {
  if(confirm("Удалить пользователя " + login + "?")) {
    await fetch("/api/users/" + encodeURIComponent(login), {method:"DELETE"});
    loadUsers();
  }
}

function togglePassword(login, realPassword, btn) {
  const displayElement = document.getElementById(`pwd-display-${login}`);
  if (btn.dataset.state === "hidden") {
    displayElement.textContent = realPassword;
    btn.innerHTML = '<i class="bi bi-eye-slash"></i>';
    btn.title = "Скрыть пароль";
    btn.dataset.state = "shown";
  } else {
    displayElement.textContent = '*'.repeat(realPassword.length);
    btn.innerHTML = '<i class="bi bi-eye"></i>';
    btn.title = "Показать пароль";
    btn.dataset.state = "hidden";
  }
}

async function copyCredentials(login, password, button) {
    const text = `Ваш логин: ${login}\nВаш пароль: ${password}`;
    
    try {
        await navigator.clipboard.writeText(text);
        button.innerHTML = '<i class="bi bi-check"></i>';
        setTimeout(() => {
            button.innerHTML = '<i class="bi bi-clipboard"></i>';
        }, 1000);
    } catch (err) {
        // Fallback
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        button.innerHTML = '<i class="bi bi-check"></i>';
        setTimeout(() => {
            button.innerHTML = '<i class="bi bi-clipboard"></i>';
        }, 1000);
    }
}

async function reloadSquid() {
  if(!confirm("Добавить всех пользователей в Squid и перезагрузить сервис?")) return;
  let res = await fetch("/api/reload_squid", {method: "POST"});
  let data = await res.json();
  if(data.status === "ok") {
    alert(data.message);
  } else {
    alert("Ошибка при перезагрузке Squid");
  }
}

loadUsers();
</script>
</body>
</html>